name: release
on:
  push:
    branches:
      - main
      - feature/luals-library # For testing this PR
  schedule:
    - cron: '0 0 * * 2'
jobs:
  release:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Install zip
        uses: montudor/action-zip@v1
      # - name: Scrape wiki
      #   run: npm run cli:scrape-wiki
      - name: Testing by just writing some files to the output folder directly (saves us scraping the wiki)
        run: |
          mkdir -p ./output/ai
          echo "{\"lastUpdate\": \"$(date --iso-8601=seconds)\"}" > ./output/__metadata.json
          echo "[{\"url\":\"https://wiki.facepunch.com/gmod/ai.GetScheduleID\",\"title\":\"ai.GetScheduleID - Garry's Mod Wiki\",\"realm\":\"server\",\"function\":{\"name\":\"ai.GetScheduleID\",\"description\":\"Translates a schedule name to its corresponding ID.\",\"arguments\":[{\"name\":\"sched\",\"type\":\"string\",\"description\":\"Then schedule name. In most cases, this will be the same as the Enums/SCHED name.\"}],\"returns\":[{\"type\":\"number\",\"description\":\"The schedule ID, see Enums/SCHED. Returns -1 if the schedule name isn't valid.\"}]}}]" > ./output/ai/getscheduleid.json
          echo "---[SERVER] Translates a schedule name to its corresponding ID." > ./output/ai/getscheduleid.lua
          echo "---@param sched string Then schedule name. In most cases, this will be the same as the Enums/SCHED name." >> ./output/ai/getscheduleid.lua
          echo "---@return number The schedule ID, see Enums/SCHED. Returns -1 if the schedule name isn't valid." >> ./output/ai/getscheduleid.lua
          echo "function ai.GetScheduleID(sched) end" >> ./output/ai/getscheduleid.lua
      - name: Pack release
        run: npm run cli:pack-release
      - name: Get release files and version
        id: release_json
        run: |
          content=`cat ./dist/release/release.json`
          # the following lines are only required for multi line json
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          # end of optional handling for multi line json
          echo "::set-output name=releaseJson::$content"
      - name: Publish Lua Language Server Library
        run: npm run cli:publish-library
      - name: Copy library to it's own branch
        env:
          LIBRARY_PATH: dist/libraries/garrysmod
          TARGET_BRANCH: lua-language-server-addon
        run: |
          libraryPathFirstPart=`echo $LIBRARY_PATH | cut -d'/' -f1`
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          # git fetch
          git checkout $TARGET_BRANCH 2>/dev/null || git checkout -b $TARGET_BRANCH
          rm -rf $(ls -A | grep -vE ".git$|^$libraryPathFirstPart$")
          mv $LIBRARY_PATH/* .
          rm -rf $libraryPathFirstPart
          git add -A
          git diff-index --quiet HEAD || git commit -am "üöÄ Update ${{ fromJson(steps.release_json.outputs.releaseJson).version }}"
          git push origin $TARGET_BRANCH # push to remote branch
      - name: Move back to original branch
        uses: actions/checkout@v3
      - name: Create release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ fromJson(steps.release_json.outputs.releaseJson).version }}
          tag: ${{ fromJson(steps.release_json.outputs.releaseJson).tag }}
          body: |
            # üìÖ ${{ fromJson(steps.release_json.outputs.releaseJson).version }}
            **This release was automatically generated by a GitHub Action.**

            ## üìù Released Archives
            - `*.lua.zip` : EmmyLua definitions
            - `*.json.zip` files: JSON definitions so you can generate your own definitions
              
            ## üìö Lua Language Server Addon
            With this release a new addon for [the Lua Language Server](https://github.com/LuaLS/lua-language-server) was made available in [the LLS-Addons repository](https://github.com/LuaLS/LLS-Addons).
            The source of this release can be found in [the lua-language-server-addon branch](https://github.com/luttje/glua-api-snippets/tree/lua-language-server-addon).

          artifacts: ${{ join(fromJson(steps.release_json.outputs.releaseJson).releaseFiles, ',') }}
          